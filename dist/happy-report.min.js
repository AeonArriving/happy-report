"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function o(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,r){return t&&o(e.prototype,t),r&&o(e,r),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var Ajax=require("./ajax"),HappyPerformance=function(){function r(e,t){_classCallCheck(this,r),this.init(e),this.fn=t}return _createClass(r,[{key:"init",value:function(e){this.initOptions(e),this.initOptions(),this.initErrorDefault(),this.initEvent()}},{key:"initOptions",value:function(e){this.options=Object.assign({domain:"",outTimt:1e3,filterUrl:[],isUploadPagePerformanceData:!0,isUploadPageResource:!0,isUploadPageErrorInfo:!0},e||{})}},{key:"initConfig",value:function(){this.config={resourceList:[],performance:{},errorList:[],fetchNumber:0,loadNumer:0,ajaxLength:0,fetLength:0,ajaxMsg:[],goingType:"",haveAjax:!1,haveFetch:!1,preUrl:document.referrer&&document.referrer!==window.location.href?document.referrer:"",appVersion:navigator.appVersion,page:window.location.href}}},{key:"initErrorDefault",value:function(){this.errorDefault={time:"",resource:"js",msg:"",data:{}}}},{key:"initDefaultData",value:function(){this.beginTime=(new Date).getTime(),this.loadTime=0,this.ajaxTime=0,this.fetchTime=0}},{key:"initEvent",value:function(){var e=this;this.options.isUploadPageErrorInfo&&this.handleError(),addEventListener("load",function(){e.loadTime=(new Date).getTime()-e.beginTime,getAjaxAndOnLoadTime()},!1),(this.options.isUploadPageResource||this.options.isUploadPageErrorInfo)&&this.handleFetch(),(this.options.isUploadPageResource||this.options.isUploadPageErrorInfo)&&this.handleAjax()}},{key:"handleError",value:function(){var i=this;window.addEventListener("error",function(e){var t=Object.assign({},i.errorDefault);t.resource="resource",t.time=(new Date).getTime(),t.msg=e.target.localName+" 读取失败",t.method="GET",t.data={target:e.target.localName,type:e.type,resourceUrl:e.target.currentSrc},e.target!=window&&i.config.errorList.push(t)},!0),window.onerror=function(e,t,r,o,n){var a=Object.assign({},i.errorDefault);setTimeout(function(){o=o||window.event&&window.event.errorCharacter||0,a.msg=n&&n.stack?n.stack.toString():e,a.method="GET",a.data={line:r,col:o,resourceUrl:t},a.time=(new Date).getTime(),i.config.errorList.push(a)},0)}}},{key:"getAjaxAndOnLoadTime",value:function(){var e=this.config,t=e.haveAjax,r=e.haveFetch,o=this.ajaxTime,n=this.fetchTime,a=this.loadTime;t&&r&&a&&n?this.reportData():t&&!r&&o&&a?this.reportData():!t&&r&&a&&n?this.reportData():t||r||!a||this.reportData()}},{key:"reportData",value:function(){var r=this;setTimeout(function(){r.options.isUploadPagePerformanceData&&r.performancePage(),r.options.isUploadPageResource&&r.performanceResource();var e=r.config,t={page:e.page,preUrl:e.preUrl,appVersion:e.appVersion,errorList:e.errorList,performance:e.performance,resourceList:e.resourceList};r.fn&&r.fn(t),!r.fn&&window.fetch&&fetch(r.options.domain,{method:"POST",type:"report-data",body:JSON.stringify(t)})},this.options.outTimt)}},{key:"performancePage",value:function(){if(window.performance){var e=performance.timing;this.config.performance={dnst:e.domainLookupEnd-e.domainLookupStart||0,tcpt:e.connectEnd-e.connectStart||0,wit:e.responseStart-e.navigationStart||0,domt:e.domContentLoadedEventEnd-e.navigationStart||0,lodt:e.loadEventEnd-e.navigationStart||0,radt:e.fetchStart-e.navigationStart||0,rdit:e.redirectEnd-e.redirectStart||0,uodt:e.unloadEventEnd-e.unloadEventStart||0,reqt:e.responseEnd-e.requestStart||0,andt:e.domComplete-e.domInteractive||0}}}},{key:"performanceResource",value:function(){var a=this;if(!window.performance&&!window.performance.getEntries)return!1;var e=performance.getEntriesByType("resource"),i=[];if(!e&&!e.length)return i;e.forEach(function(e){var t={name:e.name,method:"GET",type:e.initiatorType,duration:e.duration.toFixed(2)||0,decodedBodySize:e.decodedBodySize||0,nextHopProtocol:e.nextHopProtocol},r=a.config.ajaxMsg;if(r&&r.length)for(var o=0,n=r.length;o<n;o++)r[o].url===e.name&&(t.method=r[o].method||"GET",t.type=r[o].type||t.type);i.push(t)}),this.conf.resourceList=i}},{key:"handleFetch",value:function(){if(window.fetch){var e=fetch,o=this;window.fetch=function(){var r=o.fetchArg(arguments);return"report-data"!==r.type&&(o.clearPerformance(),o.conf.ajaxMsg.push(r),o.conf.fetLength=o.conf.fetLength+1,o.conf.haveFetch=!0),e.apply(this,arguments).then(function(e){if("report-data"!==r.type)return o.getFetchTime("success"),e}).catch(function(e){if("report-data"!==r.type){o.getFetchTime("error");var t=Object.assign({},o.errorDefault);return t.time=(new Date).getTime(),t.resource="fetch",t.msg="fetch请求错误",t.method=r.method,t.data={resourceUrl:r.url,text:e.stack||e,status:0},o.conf.errorList.push(t),e}})}}}},{key:"handleAjax",value:function(){var n=this;Ajax({onreadystatechange:function(e){4===e.readyState&&setTimeout(function(){"load"!==n.config.goingType&&(n.config.goingType="readychange",n.getAjaxTime("readychange"),(e.status<200||300<e.status)&&(e.method=e.args.method,n.ajaxResponse(e)))},600)},onerror:function(e){n.getAjaxTime("error"),e.args&&e.args.length&&(e.method=e.args.method,e.responseURL=e.args.url,e.statusText="ajax请求路径错误!"),n.ajaxResponse(e)},onload:function(e){if(4===e.readyState){if("readychange"===n.config.goingType)return;n.config.goingType="load",n.getAjaxTime("load"),(e.status<200||300<e.status)&&(e.method=e.args.method,n.ajaxResponse(e))}},open:function(t,e){if(n.options.filterUrl&&n.options.filterUrl.length){var r=!1;if(n.options.filterUrl.forEach(function(e){-1!=t[1].indexOf(e)&&(r=!0)}),r)return}var o={url:t[1],method:t[0]||"GET",type:"xmlhttprequest"};n.args=o,n.clearPerformance(),n.config.ajaxMsg.push(o),n.config.ajaxLength=n.config.ajaxLength+1,n.config.haveAjax=!0}})}},{key:"fetchArg",value:function(){var e={method:"GET",type:"fetchrequest"},t=Array.prototype.slice.apply(arg);if(!t||!t.length)return e;try{1===t.length?"string"==typeof t[0]?e.url=t[0]:"object"===_typeof(t[0])&&(e.url=t[0].url,e.method=t[0].method):(e.url=t[0],e.method=t[1].method,e.type=t[1].type)}catch(e){}return e}},{key:"clearPerformance",value:function(){if(window.performance||window.performance.clearResourceTimings){var e=this.config,t=e.haveAjax,r=e.haveFetch,o=e.ajaxLength,n=e.fetLength;t&&r&&0==o&&0==n?clear():!t&&r&&0==n?clear():t&&!r&&0==o&&clear()}}},{key:"clear",value:function(){performance.clearResourceTimings(),this.config.performance={},this.config.errorList=[],this.config.preUrl="",this.config.resourceList="",this.config.page=window.location.href}},{key:"getFetchTime",value:function(){this.config.fetchNumber+=1,this.config.fetLength===this.config.fetchNumber&&(type,this.config.fetchNumber=this.config.fetLength=0,this.fetchTime=(new Date).getTime()-beginTime,this.getAjaxAndOnLoadTime())}},{key:"getAjaxTime",value:function(){this.config.loadNumer+=1,this.config.loadNumer===this.config.ajaxLength&&("load"==type||type,this.config.ajaxLength=this.config.loadNumer=0,this.ajaxTime=(new Date).getTime()-this.beginTime,this.getAjaxAndOnLoadTime())}},{key:"ajaxResponse",value:function(e,t){var r=Object.assign({},errordefo);r.time=(new Date).getTime(),r.resource="ajax",r.msg=e.statusText||"ajax请求错误",r.method=e.method,r.data={resourceUrl:e.responseURL,text:e.statusText,status:e.status},this.config.errorList.push(r)}}]),r}();